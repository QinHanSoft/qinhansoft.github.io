<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android高级进阶笔记-Android插件框架机制 | 长桥の情书</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android高级进阶笔记-Android插件框架机制</h1><a id="logo" href="/.">长桥の情书</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android高级进阶笔记-Android插件框架机制</h1><div class="post-meta">Dec 4, 2017</div><a data-disqus-identifier="2017/12/04/Android-Senior-Plug-In/" href="/2017/12/04/Android-Senior-Plug-In/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>随着移动端产品模块的不断增加，APK的体积也在不断增长，APK的方法数很可能会触及64K方法数限制问题，虽然Google给出了MultiDex的解决方案，但并不完美，其余方面且不提，首先是APK启动速度都会受到影响。</p>
<p>为了解决上述问题，我们引入插件框架的概念。插件框架的基本形式是将一个APK中的不同功能模块进行拆分，并打入到不同的dex文件或者APK文件中，主工程只是一个空壳，提供了用来加载模块dex或者APK的框架。使用插件框架的好处有很多。</p>
<ul>
<li>提升Android Studio工程的构建速度：每个模块作为一个独立的插件进行开发和调试，Android Studio只需要加载对应的模块和依赖库即可，不需要再像插件化之前那样加载所有的模块，构建速度得到明显提升。</li>
<li>提高应用的启动速度：引入插件化框架，应用启动时可以选择只加载必须的模块，其他非必须模块可以在使用到的时候再进行加载，同时规避了使用MultiDex方案多只的应用启动需要在主线程中执行所有dex文件的解压、dexopt和加载操作，避免了应用启动黑屏和ANR的问题；</li>
<li>支持多团队并行开发：每个模块独立成单独的插件、不同模块的开发在定义好接口的前提下，可以做到互不干扰的并行开发；</li>
<li>在线动态加载或者更新模块：每个插件可以做到在线热更新，从而实现功能的快速上下线，不需要依赖应用市场的发布；</li>
<li>按需加载不同的模块，实现灵活的功能配置：不同插件之间是相互独立的，可以很容易做到根据业务需求实现插件的热插拔；</li>
</ul>
<p>在Android中实现插件框架，需要解决的问题主要如下：</p>
<ul>
<li>资源和代码的加载；</li>
<li>Android生命周期的管理和组件的注册；</li>
<li>插件APK和宿主APK资源引用的冲突问题。</li>
</ul>
<h3 id="1-基本概念"><a href="#1-基本概念" class="headerlink" title="1. 基本概念"></a>1. 基本概念</h3><h4 id="1-1-宿主和插件"><a href="#1-1-宿主和插件" class="headerlink" title="1.1 宿主和插件"></a>1.1 宿主和插件</h4><p>宿主APK实现了一套插件的加载和管理的框架，它作为应用的主工程存在，插件APK都是依托于宿主APK而存在的。</p>
<p>插件APK是每个独立的功能模块，可以通过在线配置和更新实现插件APK在宿主APK中的上线和下线，以及动态更新等功能。</p>
<h4 id="1-2-ClassLoader机制"><a href="#1-2-ClassLoader机制" class="headerlink" title="1.2 ClassLoader机制"></a>1.2 ClassLoader机制</h4><p>Android中的ClassLoader机制主要用来加载dex文件，系统提供了两个API可供选择：</p>
<ul>
<li>PathClassLoader：只能加载已经安装到Android系统中的APK文件，因此不符合插件化的需求，不做考虑；</li>
<li>DexClassLoader：支持加载外部的APK、jar或者dex文件，正好符合插件化的需求，所有的插件化方案都是使用DexClassLoader来加载插件APK中的.class文件的。</li>
</ul>
<h3 id="2-开源框架"><a href="#2-开源框架" class="headerlink" title="2. 开源框架"></a>2. 开源框架</h3><p>最近一两年涌现了多种插件框架的实现方案，不同的方案存在各自的优缺点，下面简单介绍下目前几个主要插件框架的基本原理和优缺点。</p>
<h4 id="2-1-android-pluginmgr"><a href="#2-1-android-pluginmgr" class="headerlink" title="2.1 android-pluginmgr"></a>2.1 <a href="https://github.com/houkx/android-pluginmgr" target="_blank" rel="external">android-pluginmgr</a></h4><p>android-pluginmgr的实现原理是使用DexMaker的动态热部署功能来生成Activity，让这个Activity继承目标插件所在的Activity。它的主要特性如下：</p>
<ul>
<li>插件App不需要设置任何规则或限制；</li>
<li>技术方法相对成熟稳定；</li>
</ul>
<p>它的主要缺点如下：</p>
<ul>
<li>基于热部署实现，因此框架的稳定性有待加强，OOM问题较突出；</li>
<li>只支持Activity，不支持其他组件，通用性较差。</li>
</ul>
<h4 id="2-2-dynamic-load-apk"><a href="#2-2-dynamic-load-apk" class="headerlink" title="2.2 dynamic-load-apk"></a>2.2 <a href="https://github.com/singwhatiwanna/dynamic-load-apk" target="_blank" rel="external">dynamic-load-apk</a></h4><p>dynamic-load-apk是基于代理的方式实现插件框架的，需要按照一定的规则来开发插件APK，插件中的组件需要实现经过改造后的Activity、FragmentActivity、Service等的子类。它的主要特性如下：</p>
<ul>
<li>插件需要遵循一定的规则，因此安全方面更加可控；</li>
<li>方案简单，适用于自身少量代码的插件化改造；</li>
</ul>
<p>它的主要缺点如下：</p>
<ul>
<li>不支持通过this调用组件的方法，需要通过that去调用；</li>
<li>由于APK中的Activity没有注册，不支持隐式调用APK内部的Activity；</li>
<li>插件变形和改造过程中，需要考虑兼容性问题比较多，联调起来会比较费时费力。</li>
</ul>
<h4 id="2-3-DynamicAPK"><a href="#2-3-DynamicAPK" class="headerlink" title="2.3 DynamicAPK"></a>2.3 <a href="https://github.com/CtripMobile/DynamicAPK" target="_blank" rel="external">DynamicAPK</a></h4><p>DynamicAPK是携程实现的一种实现多APK/DEX加载的插件框架解决方案，使用这个框架，我们可以实现Android Studio多module工程并行开发模式，同时可以实现在线热修复功能。</p>
<p>它的主要特性如下：</p>
<ul>
<li>很少的修改即可实现插件化改造：DynamicAPK不是基于代理方式实现Activity等组件的生命周期管理，因此改造起来更方便；同时通过修改aapt实现插件中资源的管理，是的R.java中的资源引用和普通Android工程没有区别；</li>
<li>提升工程编译速度，更好地实现并行开发；</li>
<li>按需下载和更新模块的代码和资源，实现在线热更新和热修复；</li>
<li>提高App启动速度：DynamicAPK实现在App启动时按需加载必须的模块，规避了MultiDex方案在启动时需要在主线程中执行所有dex的解压、dexopt、加载操作，从而提升了应用的启动速度，并避免可能引起的启动黑屏和ANR；</li>
</ul>
<p>它的主要缺点如下：</p>
<ul>
<li>插件工程不支持Native代码，例如不支持so库；</li>
<li>插件工程不支持对Library工程、aar、maven远程仓库的依赖。</li>
</ul>
<h4 id="2-4-DroidPlugin"><a href="#2-4-DroidPlugin" class="headerlink" title="2.4 DroidPlugin"></a>2.4 <a href="https://github.com/DroidPluginTeam/DroidPlugin" target="_blank" rel="external">DroidPlugin</a></h4><p>DroidPlugin是360手机助手实现的一种插件框架，它可以直接运行第三方的独立APK文件，完全不需要对APK进行修改或安装。</p>
<p>它的主要特性如下：</p>
<ul>
<li>支持Android四大组件，而且插件中的组件不需要在宿主APK中注册；</li>
<li>支持Android 2.3及以上系统，支持所有系统API；</li>
<li>插件与插件之间，插件与宿主之间的代码和资源完全隔离；</li>
<li>实现了进程管理，插件的空进程会被及时回收，占用内存低。</li>
</ul>
<p>它的主要缺点如下：</p>
<ul>
<li>插件APK中不支持自定义资源的Notification；</li>
<li>插件APK中无法注册具有特殊IntentFilter的四大组件；</li>
<li>缺乏对Native层的Hook操作，对于某些带有Native代码的插件APK支持不好，可能无法正常运行；</li>
<li>由于插件与插件，插件与宿主之间的代码完全隔离，因此，插件与插件，插件与宿主之间通信只能通过Android系统级别的通信方式。</li>
</ul>
<h4 id="2-5-Small"><a href="#2-5-Small" class="headerlink" title="2.5 Small"></a>2.5 <a href="https://github.com/wequick/small" target="_blank" rel="external">Small</a></h4><p>Small的目标是实现最轻巧的跨平台插件化框架，它最低支持Android API Level 8和iOS 7.0。</p>
<p>它的主要特性如下：</p>
<ul>
<li>所有插件支持内置于宿主包中；</li>
<li>插件的编码和资源文件的使用与开发普通应用没有差别；</li>
<li>通过设定URI，宿主以及Native应用插件，Web插件，在线网页等能够方便地进行通信；</li>
<li>支持Android、iOS和HTML5，三种可以通过同一套JavaScript接口实现通信。</li>
</ul>
<p>Small目前看来唯一的不足是暂不支持Service的动态注册，不过这个可以通过将Service预先注册在宿主的AndroidManifest.xml文件中进行规避，因为Service的更新频率通常非常低。</p>
<style type="text/css">
    p {
        text-indent: 2em; /*首行缩进*/
    }
</style>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/12/12/Android-Deep-AMS/" class="pre">深入理解Android卷II笔记-ActivityManagerService</a><a href="/2017/12/02/Android-Senior-tech-stack/" class="next">Android高级进阶笔记-基于开源项目搭建属于自己的技术堆栈</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = '长桥の情书';
var disqus_identifier = '2017/12/04/Android-Senior-Plug-In/';
var disqus_title = 'Android高级进阶笔记-Android插件框架机制';
var disqus_url = 'http://yoursite.com/2017/12/04/Android-Senior-Plug-In/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//长桥の情书.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/25/Day05-breaking/">第五天</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/24/Day04-breaking/">第四天</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/Day03-breaking/">第三天</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/22/Day02-breaking/">第二天</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/21/Day01-breaking/">第一天</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/14/Android-intent-bug/">Android 使用Intent传递参数时的一个bug</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/26/rx-Operate-Create-Start/">Start</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/29/Build-a-Responseive-UI-with-ConstraintLayout/">Build a Responseive UI with ConstraintLayout</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/17/html5-fkjava-char2/">疯狂HTML 5+CSS 3+JavaScript讲义笔记——2.HTML 5的常用元素与属性</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/23/rx-Operate-Create-Error/">Error</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//长桥の情书.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">长桥の情书.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>