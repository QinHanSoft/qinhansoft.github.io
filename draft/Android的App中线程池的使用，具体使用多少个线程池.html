<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title> | 长桥の情书</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">长桥の情书</h1><a id="logo" href="/.">长桥の情书</a><p class="description"></p></div><div id="nav-menu"><a href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-content"><p><a href="https://www.zhihu.com/question/37804956" target="_blank" rel="external">Android的App中线程池的使用，具体使用多少个线程池</a></p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>今天特意查看下AsyncTask的源码（API22），发现是有一个默认的线程池的。另外，我们也会使用以下第三方框架，想UIL（Android-Universal-Image-Loader）以及AsyncHttpClient等都是有自己的线程池的。那么应该如何在项目中，正确的使用线程池呢以及线程池的配置？</p>
<p>一个App是会用到多个第三方库，而第三方库都是有自己的线程池的。我们需不需要自己统一定义一个线程池，然后设置给第三方库。如果不需要，那就任由第三方库数目的累加，而导致线程池数目的累加，这样在一个App中就会存在多个线程池，这样没什么性能问题吗？</p>
<h3 id="1-小楼一夜听春雨"><a href="#1-小楼一夜听春雨" class="headerlink" title="1.小楼一夜听春雨"></a>1.小楼一夜听春雨</h3><p>虽然说线程池的使用跟具体场景有关，但是其实有章可循。<br>在回答这个问题之前，让我们先看一下几个经典的图片加载框架是如何处理的。</p>
<h4 id="1-1-Android-Universal-Image-Loader（以下简称UIL）"><a href="#1-1-Android-Universal-Image-Loader（以下简称UIL）" class="headerlink" title="1.1 Android-Universal-Image-Loader（以下简称UIL）"></a>1.1 Android-Universal-Image-Loader（以下简称UIL）</h4><p>UIL的线程池是可以让开发者自己配置的，如果没有主动配置，则会使用默认配置，在ImageLoaderConfiguration的内部类Builder中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initEmptyFieldsWithDefaultValues</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (taskExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">        taskExecutor = DefaultConfigurationFactory.createExecutor(</div><div class="line">                threadPoolSize, threadPriority, tasksProcessingType);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        customExecutor = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (taskExecutorForCachedImages == <span class="keyword">null</span>) &#123;</div><div class="line">        taskExecutorForCachedImages = DefaultConfigurationFactory.createExecutor(</div><div class="line">                threadPoolSize, threadPriority, tasksProcessingType);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        customExecutorForCachedImages = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中<em>taskExecutor</em>是加载任务线程池，<em>taskExecutorForCachedImages</em>是缓存处理线程池。其中<em>threadPoolSize</em>和<em>threadPriority</em>的迷人值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_THREAD_POOL_SIZE = <span class="number">3</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_THREAD_PRIORITY = Thread.NORM_PRIORITY - <span class="number">2</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> QueueProcessingType DEFAULT_TASK_PROCESSING_TYPE = QueueProcessingType.FIFO;</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">private</span> QueueProcessingType tasksProcessingType = DEFAULT_TASK_PROCESSING_TYPE;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> threadPoolSize = DEFAULT_THREAD_POOL_SIZE;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> threadPriority = DEFAULT_THREAD_PRIORITY;</div></pre></td></tr></table></figure>
<p>可见UIL的加载任务线程池和缓存处理线程池的默认大小都是3，同时默认线程优先级是Thread.NORM_PRIORITY - 2，这个优先级已经比较低了，主要是防止它抢占太多CPU时间片，从而影响主线程的执行，线程池的任务处理类型都是FIFO。</p>
<h4 id="1-2-Picasso"><a href="#1-2-Picasso" class="headerlink" title="1.2 Picasso"></a>1.2 Picasso</h4><p>类似的，Picasso的线程池也可以开发者自己配置，如果没有配置，则使用默认值，在<em>Picasso#Builder#build()</em>中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Picasso <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</div><div class="line">        service = <span class="keyword">new</span> PicassoExecutorService();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    Dispatcher dispatcher = <span class="keyword">new</span> Dispatcher(context, service, HANDLER, downloader, cache, stats);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Picasso(context, dispatcher, cache, listener, transformer, requestHandlers, stats,</div><div class="line">            defaultBitmapConfig, indicatorsEnabled, loggingEnabled);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，使用了自定义类<em>PicassoExecutorService</em>，这个类代码很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PicassoExecutorService</span> <span class="keyword">extends</span> <span class="title">ThreadPoolExecutor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_THREAD_COUNT = <span class="number">3</span>;</div><div class="line"></div><div class="line">    PicassoExecutorService() &#123;</div><div class="line">        <span class="keyword">super</span>(DEFAULT_THREAD_COUNT, DEFAULT_THREAD_COUNT, <span class="number">0</span>, TimeUnit.MILLISECONDS,</div><div class="line">                <span class="keyword">new</span> PriorityBlockingQueue&lt;Runnable&gt;(), <span class="keyword">new</span> Utils.PicassoThreadFactory());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</div><div class="line">        PicassoFutureTask ftask = <span class="keyword">new</span> PicassoFutureTask((BitmapHunter) task);</div><div class="line">        execute(ftask);</div><div class="line">        <span class="keyword">return</span> ftask;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见其默认线程池大小为3，工作队列为优先阻塞队列，而<em>Utils.PicassoThreadFactory()</em>调用到了<em>PicassoThreadFactory</em>，该类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PicassoThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"NullableProblems"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PicassoThread(r);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很简单，就是继承自ThreadFactory的工厂类，而PicassoThread如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PicassoThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PicassoThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(r);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        Process.setThreadPriority(THREAD_PRIORITY_BACKGROUND);</div><div class="line">        <span class="keyword">super</span>.run(r);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见，其线程优先级为THREAD_PRIORITY_BACKGROUND。</p>
<p>但是，Picasso真正灵活的地方是可以根据网络状况调节线程池的大小，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">adjustThreadCount</span><span class="params">(NetworkInfo info)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span> || !info.isConnectedOrConnecting()) &#123;</div><div class="line">        setThreadCount(DEFAULT_THREAD_COUNT);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">switch</span> (info.getType()) &#123;</div><div class="line">        <span class="keyword">case</span> ConnectivityManager.TYPE_WIFI:</div><div class="line">        <span class="keyword">case</span> ConnectivityManager.TYPE_WIMAX：</div><div class="line">        <span class="keyword">case</span> ConnectivityManager.TYPE_ETHERNET:</div><div class="line">            setThreadCount(<span class="number">4</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> ConnectivityManager.TYPE_MOBILE:</div><div class="line">            <span class="keyword">switch</span> (info.getSubtype()) &#123;</div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_LTE: <span class="comment">//4G</span></div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_HSPAP:</div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EHRPD:</div><div class="line">                    setThreadCount(<span class="number">3</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_UMTS: <span class="comment">//3G</span></div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_CDMA:</div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EVDO_0:</div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EVDO_A:</div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EVDO_B:</div><div class="line">                    setThreadCount(<span class="number">2</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_GPRS:</div><div class="line">                <span class="keyword">case</span> TelephonyManager.NETWORK_TYPE_EDGE:</div><div class="line">                    setThreadCount(<span class="number">1</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    setThreadCount(DEFAULT_THREAD_COUNT);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            setThreadCount(DEFAULT_THREAD_COUNT);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setThreadCount</span><span class="params">(<span class="keyword">int</span> threadCount)</span> </span>&#123;</div><div class="line">    setCorePoolSize(threadCount);</div><div class="line">    setMaximumPoolSize(threadCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见在WiFi下线程数为4，而4G下线程数为3，3G下为2，2G下为1，默认状况是3。这样做的原因是在慢网络下下载速度慢，较小的线程就足以处理。</p>
<h4 id="1-3-Glide"><a href="#1-3-Glide" class="headerlink" title="1.3 Glide"></a>1.3 Glide</h4><p>Glide线程池也可以配置，下面我们看一下它的默认配置，在GlideBuilder#createGlide()中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function">Glide <span class="title">createClide</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (sourceExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">        sourceExecutor = GlideExecutor.newSourceExecutor();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (diskCacheExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">        diskCacheExecutor = GlideExecutor.newDiskCacheExecutor();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Glide(</div><div class="line">        context,</div><div class="line">        engine,</div><div class="line">        memoryCache,</div><div class="line">        bitmapPool,</div><div class="line">        arrayPool,</div><div class="line">        connectivityMonitorFactory,</div><div class="line">        logLevel,</div><div class="line">        defaultRequestOptions.lock());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>类似的，也有两个线程池，其中sourceExecutor用于缓存未命中Glide的加载、解码和转换任务，diskCacheExecutor用于缓存命中时的加载、解码和转换任务，先来看GlideExecutor.newSourceExecutor():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GlideExecutor <span class="title">newSourceExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> newSourceExecutor(calculateBestThreadCount(), DEFAULE_SOURCE_EXECUTOR_NAME,</div><div class="line">        UncaultThrowableStrategy.DEFAULT);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GlideExecutor <span class="title">newSourceExecutor</span><span class="params">(<span class="keyword">int</span> threadCount, String name,</span></span></div><div class="line"><span class="function"><span class="params">        UncaughtThrowableStrategy uncaughtThrowableStrategy)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> GlideExecutor(threadCount, name, uncaughtThrowableStrategy,</div><div class="line">                    <span class="keyword">false</span> <span class="comment">/*preventNetworkOperations*/</span>, <span class="keyword">false</span> <span class="comment">/*executeSynchronously*/</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">GlideExecutor(<span class="keyword">int</span> poolSize, String name,</div><div class="line">        UncaughtThrowableStrategy uncaughtThrowableStrategy, <span class="keyword">boolean</span> preventNetworkOperations,</div><div class="line">        <span class="keyword">boolean</span> executrSynchronously) &#123;</div><div class="line">            <span class="keyword">super</span>(</div><div class="line">                poolSize <span class="comment">/*corePoolSize*/</span>,</div><div class="line">                poolSize <span class="comment">/*maximumPoolSize*/</span>,</div><div class="line">                <span class="number">0</span> <span class="comment">/*keepAliveTime*/</span>,</div><div class="line">                TimeUnit.MILLISECONDS,</div><div class="line">                <span class="keyword">new</span> PriorityBlockingQueue&lt;Runnable&gt;(),</div><div class="line">                <span class="keyword">new</span> DefaultThreadFactory(name, uncaughtThrowableStrategy, preventNetworkOperations));</div><div class="line">            <span class="keyword">this</span>.executeSynchronously = executrSynchronously;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在calculateBestThreadCount()中会根据CPU的数量和Java虚拟机中可用的处理器数量来选择合适的线程数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateBestThreadCount</span><span class="params">()</span> </span>&#123;</div><div class="line">    File[] cpus = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        File cupInfo = <span class="keyword">new</span> File(CPU_LOCATION);</div><div class="line">        <span class="keyword">final</span> Pattern cpuNamePattern = Pattern.compile(CPU_NAME_REGEX);</div><div class="line">        cpus = cupInfo.listFile(<span class="keyword">new</span> FilenameFilter() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file, String s)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> cpuNamePattern.matcher(s).matches();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> cpuCount = cpus != <span class="keyword">null</span> ? cpus.length : <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> availableProcessors = Math.max(<span class="number">1</span>, Runtime.getRuntime().availableProcessors());</div><div class="line">    <span class="keyword">return</span> Math.min(MAXIMUM_AUTOMATIC_THREAD_COUNT, Math.max(availableProcessors, cpuCount));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码很简单，就不展开讲了。</p>
<p>默认值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SOURCE_EXECUTOR_NAME = <span class="string">"source"</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DISK_CACHE_EXECUTOR_NAME = <span class="string">"disk-cache"</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_DISK_CACHE_EXECUTOR_THREADS = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"GlideExecutor"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CPU_NAME_REGEX = <span class="string">"cpu[0-9]+"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CPU_LOCATION = <span class="string">"/sys/devices/system/cpu/"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_AUTOMATIC_THREAD_COUNT = <span class="number">4</span>;</div></pre></td></tr></table></figure>
<p>可见，在Glide中，加载缓存未命中的线程池会根据CPU的数量和Java虚拟机中可用的处理器数量来选择合适的线程数，但是最多不超过4。</p>
<p>再看GlideExecutor.newDiskCacheExecutor()，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GlideExecutor <span class="title">newDiskCacheExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> newDiskCacheExecutor(DEFAULT_DISK_CACHE_EXECUTOR_THREADS,</div><div class="line">            DEFAULT_DISK_CACHE_EXECUTOR_NAME, UncaughtThrowableStrategy.DEFAULT);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，加载缓存命中的图片的线程池默认大小为1。</p>
<p>至于签名用到的DefaultThreadFactory，与Picasso中的类似，也是使用android.os.Process.THREAD_PRIORITY_BACKGROUND这个线程优先级，不再赘述。</p>
<hr>
<p>通过上面的分析，可以得到如下结论：</p>
<ol>
<li>UIL的线程池处理非常简单粗暴，没有根据CPU数量来选择，也没有根据网络状况的变化进行调整；</li>
<li>Picasso的线程池会根据网络状况的变化进行调整，在WiFi下线程数为4，而4G下为3，3G下为2，2G下为1，默认状况为3；</li>
<li>Glide加载缓存未命中的线程池会根据CPU的数量和Java虚拟机中可用的处理器数量来选择合适的线程数，但是最多不超过4，而加载缓存命中的图片的线程池默认大小为1。</li>
</ol>
</div></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = '长桥の情书';
var disqus_identifier = 'draft/Android的App中线程池的使用，具体使用多少个线程池.html';
var disqus_title = '';
var disqus_url = 'http://yoursite.com/draft/Android的App中线程池的使用，具体使用多少个线程池.html';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//长桥の情书.disqus.com/count.js" async></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/25/Android-Senior-Dispatch-Event/">Android高级进阶笔记-View的事件传递</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/20/Android-Basic-Activity/">Android开发艺术探索笔记-Activity生命周期和启动模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/31/Java-Basic-ThreadPool/">Android线程和线程池</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/22/Java-Basic-DesignPatterns/">Java开发中的23种设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/21/Java-Basic-DesignPhilosophy/">面向对象的六大设计原则</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/21/Java-Basic-OOP/">Java面向对象三大特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/20/Android/">Android技能树</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/Android-Code-Standards/">Android编码规范</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/15/Android-Table-Drive/">表驱动法在Android下的一个实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/10/Picasso-Basic-Scale/">Picasso图片缩放</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//长桥の情书.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">长桥の情书.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>